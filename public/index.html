<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIT Jamshedpur RAG Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 900px;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 26px;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: #28a745;
        }

        .status-dot.initializing {
            background: #ffc107;
        }

        .vector-stats {
            font-size: 11px;
            opacity: 0.8;
        }

        .status-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            color: #6c757d;
            transition: all 0.3s;
        }

        .btn-small:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: #3498db;
        }

        .message.user .message-avatar {
            background: #2c3e50;
        }

        .message-content {
            max-width: 70%;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.user .message-content {
            background: #3498db;
            color: white;
        }

        .message-metadata {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            font-size: 11px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .confidence-score {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .confidence-score.high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-score.medium {
            background: #fff3cd;
            color: #856404;
        }

        .message-sources {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
        }

        .source-link {
            display: block;
            color: #3498db;
            text-decoration: none;
            margin: 4px 0;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .source-link:hover {
            background: #3498db;
            color: white;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #3498db;
        }

        .send-button {
            padding: 16px 28px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 80px;
        }

        .send-button:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #6c757d;
            font-style: italic;
            padding: 12px 20px;
            background: #f8f9fa;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #6c757d;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        .quick-questions {
            padding: 12px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .quick-questions h4 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .question-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .question-pill {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .question-pill:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            color: #6c757d;
            padding: 30px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 15px;
            border-radius: 10px;
            border: 1px solid #f5c6cb;
        }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 95vh;
                border-radius: 15px;
                margin: 10px;
            }
            
            .message-content {
                max-width: 85%;
            }

            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .question-pills {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>üéì NIT Jamshedpur RAG Chatbot</h1>
            <p>Powered by LangChain & Pinecone Vector Database</p>
        </div>

        <div class="status-bar">
            <div class="status-left">
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">Connecting...</span>
                </div>
                <div class="vector-stats" id="vector-stats">
                    Vector DB: Initializing...
                </div>
            </div>
            <div class="status-actions">
                <button class="btn-small" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn-small" onclick="showStats()">üìä Stats</button>
                <button class="btn-small" onclick="showSources()">üìö Sources</button>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>üöÄ Initializing RAG system...</p>
                <p style="font-size: 12px; margin-top: 10px; opacity: 0.7;">Loading embeddings and vector database...</p>
            </div>
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <span>AI is thinking</span>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="quick-questions">
            <h4>üí° Quick Questions</h4>
            <div class="question-pills">
                <div class="question-pill" onclick="askQuestion('What is the highest placement package?')">üí∞ Highest Package</div>
                <div class="question-pill" onclick="askQuestion('What is the placement percentage?')">üìä Placement Rate</div>
                <div class="question-pill" onclick="askQuestion('Which companies visit for placements?')">üè¢ Top Companies</div>
                <div class="question-pill" onclick="askQuestion('CSE branch placement statistics')">üíª CSE Placements</div>
                <div class="question-pill" onclick="askQuestion('Tell me about internship opportunities')">üéØ Internships</div>
            </div>
        </div>

        <div class="chat-input-container">
            <input 
                type="text" 
                id="chat-input" 
                class="chat-input" 
                placeholder="Ask about placements, packages, companies, statistics..."
                onkeypress="handleKeyPress(event)"
            >
            <button id="send-button" class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let isLoading = false;
        let systemStats = null;

        // Check server health and initialize
        async function initializeChat() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateStatus('online', 'Connected');
                    updateVectorStats(data.vectorDatabase);
                    
                    if (!data.initialized) {
                        updateStatus('initializing', 'Initializing RAG system...');
                        const initResponse = await fetch('/initialize', { method: 'POST' });
                        const initData = await initResponse.json();
                        
                        if (initData.success) {
                            updateStatus('online', 'Ready');
                        } else {
                            throw new Error(initData.error);
                        }
                    }
                    
                    isInitialized = true;
                    hideLoading();
                    showWelcomeMessage();
                } else {
                    throw new Error(data.error || 'Server unhealthy');
                }
            } catch (error) {
                console.error('Failed to connect:', error);
                updateStatus('offline', 'Connection Failed');
                showErrorMessage(error.message);
            }
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            dot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        function updateVectorStats(stats) {
            const vectorStats = document.getElementById('vector-stats');
            if (stats && stats.totalVectors !== undefined) {
                vectorStats.textContent = `Vector DB: ${stats.totalVectors} documents`;
            }
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showWelcomeMessage() {
            addMessage('bot', `üëã Welcome to the NIT Jamshedpur RAG Chatbot!

I'm powered by advanced AI technologies:
‚Ä¢ üß† LangChain for intelligent processing
‚Ä¢ üîç Pinecone vector database for semantic search  
‚Ä¢ üìö Real-time web scraping for latest data
‚Ä¢ üìÑ PDF document analysis

I can help you with:
‚Ä¢ Placement statistics and percentages
‚Ä¢ Package information (highest, average, branch-wise)
‚Ä¢ Company details and recruitment patterns
‚Ä¢ Branch-specific placement data
‚Ä¢ Historical trends and analysis

Ask me anything about NIT Jamshedpur placements!`, [], 1.0, new Date().toISOString());
        }

        function showErrorMessage(error = 'Unknown error') {
            const loading = document.getElementById('loading');
            loading.innerHTML = `
                <div class="error-message">
                    <h3>‚ùå Connection Failed</h3>
                    <p>Could not connect to the RAG server.</p>
                    <p><strong>Error:</strong> ${error}</p>
                    <p style="margin-top: 10px; font-size: 12px;">
                        Please ensure the server is running and try refreshing the page.
                    </p>
                </div>
            `;
        }

        function addMessage(sender, content, sources = [], confidence = 0, timestamp = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'bot' ? 'ü§ñ' : 'üë§';
            
            // Format confidence score
            let confidenceHTML = '';
            if (sender === 'bot' && confidence > 0) {
                const confidencePercent = Math.round(confidence * 100);
                let confidenceClass = 'low';
                if (confidence > 0.8) confidenceClass = 'high';
                else if (confidence > 0.6) confidenceClass = 'medium';
                
                confidenceHTML = `
                    <div class="message-metadata">
                        <span>Response generated at ${timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString()}</span>
                        <span class="confidence-score ${confidenceClass}">
                            Confidence: ${confidencePercent}%
                        </span>
                    </div>
                `;
            }
            
            // Format sources
            let sourcesHTML = '';
            if (sources && sources.length > 0) {
                sourcesHTML = `
                    <div class="message-sources">
                        <strong>üìö Sources (${sources.length}):</strong><br>
                        ${sources.map((source, index) => 
                            `<a href="${source.url || '#'}" class="source-link" target="_blank" title="${source.text || ''}">
                                ${index + 1}. ${source.source || source.title || 'Document'} 
                                ${source.score ? `(${Math.round(source.score * 100)}% match)` : ''}
                            </a>`
                        ).join('')}
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content.replace(/\n/g, '<br>')}
                    ${sourcesHTML}
                    ${confidenceHTML}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typing-indicator').style.display = 'flex';
        }

        function hideTyping() {
            document.getElementById('typing-indicator').style.display = 'none';
        }

        async function sendMessage() {
            if (isLoading || !isInitialized) return;

            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Show typing indicator
            showTyping();
            isLoading = true;
            document.getElementById('send-button').disabled = true;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: message })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage('bot', data.answer, data.sources, data.confidence, data.timestamp);
                } else {
                    addMessage('bot', `‚ùå Sorry, I encountered an error: ${data.error}`);
                }

            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('bot', '‚ùå Sorry, I couldn\'t process your request. Please check your connection and try again.');
            } finally {
                hideTyping();
                isLoading = false;
                document.getElementById('send-button').disabled = false;
            }
        }

        function askQuestion(question) {
            const input = document.getElementById('chat-input');
            input.value = question;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function refreshData() {
            if (isLoading) return;

            updateStatus('initializing', 'Refreshing data...');
            
            try {
                const response = await fetch('/scrape', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force: true })
                });
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('online', 'Ready');
                    addMessage('bot', `üîÑ Data refresh completed successfully!
                    
üìä Summary:
‚Ä¢ ${data.summary.totalPages} web pages processed
‚Ä¢ ${data.summary.totalPDFs} PDF documents analyzed  
‚Ä¢ ${data.summary.totalLinks} links discovered
‚Ä¢ Updated at: ${new Date(data.timestamp).toLocaleString()}

I now have the latest placement information!`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                updateStatus('online', 'Ready');
                addMessage('bot', '‚ùå Failed to refresh data. Using existing information.');
            }
            
        }

        async function showStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    addMessage('bot', `üìä System Statistics:

üñ•Ô∏è **Server Status:**
‚Ä¢ Uptime: ${Math.round(stats.serverUptime / 3600)} hours
‚Ä¢ Node.js: ${stats.nodeVersion}
‚Ä¢ Environment: ${stats.nodeVersion}

üîç **Vector Database:**
‚Ä¢ Total documents: ${stats.vectorDatabase.totalVectors || 0}
‚Ä¢ Database fullness: ${Math.round((stats.vectorDatabase.indexFullness || 0) * 100)}%
‚Ä¢ Dimension: ${stats.vectorDatabase.dimension || 'N/A'}

üìö **Data Sources:**
‚Ä¢ Scraped data files: ${stats.scrapedDataFiles}
‚Ä¢ Latest file: ${stats.latestDataFile}
‚Ä¢ System initialized: ${stats.initialized ? '‚úÖ Yes' : '‚ùå No'}

Last updated: ${new Date(stats.timestamp).toLocaleString()}`);
                }
            } catch (error) {
                addMessage('bot', '‚ùå Failed to retrieve system statistics.');
            }
        }

        async function showSources() {
            try {
                const response = await fetch('/sources');
                const data = await response.json();
                
                if (data.success && data.sources.length > 0) {
                    const sourcesText = data.sources.map((source, index) => 
                        `${index + 1}. **${source.filename}**
   ‚Ä¢ Scraped: ${new Date(source.timestamp).toLocaleString()}
   ‚Ä¢ Pages: ${source.pagesScraped}, PDFs: ${source.pdfsProcessed}
   ‚Ä¢ Links: ${source.linksFound}`
                    ).join('\n\n');

                    addMessage('bot', `üìö Available Data Sources:

${sourcesText}

These sources contain placement data including statistics, company information, package details, and historical trends.`);
                } else {
                    addMessage('bot', 'üìö No data sources found. Try refreshing the data first.');
                }
            } catch (error) {
                addMessage('bot', '‚ùå Failed to retrieve data sources.');
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initializeChat);

        // Auto-refresh connection every 5 minutes
        setInterval(async () => {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                updateVectorStats(data.vectorDatabase);
            } catch (error) {
                console.log('Health check failed:', error.message);
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>